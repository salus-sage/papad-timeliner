const nunjucks = require('nunjucks');
const addCustomFilters = require('../utils/add-custom-filters');
const configureNodeLoader = require('./configure-node-loader');

function configureNunjucks(engine, userConfig, source, customLoaders) {
  const loaders = customLoaders
    ? customLoaders
    : configureNodeLoader(userConfig, source);
  // Configure env.
  const env = userConfig.customEnvironment
    ? userConfig.customEnvironment(engine, loaders, userConfig, source)
    : new nunjucks.Environment(loaders, userConfig.config);

  if (userConfig.customFilters) {
    addCustomFilters(env, userConfig.customFilters);
  }

  if (userConfig.jinjaCompat) {
    nunjucks.installJinjaCompat();
  }

  env.addFilter('raw', env.getFilter('safe'));

  return userConfig.custom ? userConfig.custom(env) : env;
}

module.exports = configureNunjucks;
