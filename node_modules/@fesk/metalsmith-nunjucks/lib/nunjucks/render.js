const renderStaticFile = require('./render-static-file');
const ignoreFrontMatter = require('../utils/ignore-front-matter');
const addLayoutToFile = require('./add-layout-to-file');
const renderFile = require('./render-file');
const renderError = require('../utils/render-error');

function renderTemplate({
  engine,
  file,
  fileName,
  layouts,
  defaultLayout,
  staticLayout,
  context,
}) {
  try {
    if (file.static) {
      return renderStaticFile({
        engine,
        staticFileName: layouts[staticLayout].fileName,
        staticFileString: ignoreFrontMatter(
          layouts[staticLayout].file.contents.toString()
        ),
        fileName,
        fileString: ignoreFrontMatter(file.contents.toString()),
        context,
      });
    }

    const fileString = addLayoutToFile(
      file,
      layouts,
      defaultLayout,
      staticLayout
    );

    return renderFile({
      engine,
      fileName,
      fileString,
      context,
    });
  } catch (err) {
    if (process.env.NODE_ENV !== 'development') {
      throw err;
    }
    return renderError(err, fileName, [
      { name: fileName, contents: file.contents.toString() },
    ]);
  }
}

module.exports = renderTemplate;
