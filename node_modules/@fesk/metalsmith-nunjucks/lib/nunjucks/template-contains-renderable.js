const lexer = require('nunjucks/src/lexer');

function templateContainerRenderable(str, blockName, options = {}) {
  const tokens = lexer.lex(str, { trimBlocks: true, ...options });

  // Finds {% block `blockName` %}
  while (!tokens.isFinished()) {
    let next = tokens.nextToken();
    if (next.type === lexer.TOKEN_WHITESPACE) {
      continue;
    }

    if (next.type === lexer.TOKEN_BLOCK_START) {
      next = tokens.nextToken();
      if (next.type === lexer.TOKEN_WHITESPACE) {
        next = tokens.nextToken();
      }

      while (!tokens.isFinished()) {
        next = tokens.nextToken();
        if (next.type === lexer.TOKEN_BLOCK_START) {
          next = tokens.nextToken();
          if (next.type === lexer.TOKEN_WHITESPACE) {
            next = tokens.nextToken();
          }
          if (next.type === lexer.TOKEN_SYMBOL && next.value === 'endmacro') {
            next = tokens.nextToken();
            if (next.type === lexer.TOKEN_WHITESPACE) {
              next = tokens.nextToken();
            }
            if (next.type === lexer.TOKEN_BLOCK_END) {
              next = tokens.nextToken();
            }
            if (next && next.type === lexer.TOKEN_WHITESPACE) {
              continue;
            }
            return !tokens.isFinished();
          }
        }
      }
      continue;
    }
    return true;
  }

  return true;
}

module.exports = templateContainerRenderable;
