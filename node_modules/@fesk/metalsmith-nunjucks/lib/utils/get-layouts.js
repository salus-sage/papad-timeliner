const path = require('path');
const ignoreFrontMatter = require('./ignore-front-matter');
const multimatch = require('multimatch');
const patchMetalsmithFile = require('./patch-metalsmith-file');

function getLayouts(
  files,
  nodeLoader,
  pattern,
  defaultLayout,
  staticLayout,
  fallback
) {
  const layouts = (multimatch(Object.keys(files), pattern) || []).reduce(
    (acc, file) => {
      const fileObject = files[file];
      const layoutName = fileObject.layoutName || path.parse(file).name;
      acc[layoutName] = { fileName: file, file: files[file] };
      if (defaultLayout === layoutName && defaultLayout !== 'default-layout') {
        acc['default-layout'] = acc[layoutName];
      }
      return acc;
    },
    {}
  );

  if (!layouts[defaultLayout]) {
    layouts[defaultLayout] = patchMetalsmithFile(
      nodeLoader,
      fallback.defaultLayout
    );
  }

  if (!layouts[staticLayout]) {
    layouts[staticLayout] = patchMetalsmithFile(
      nodeLoader,
      fallback.staticLayout
    );
  }

  return layouts;
}

module.exports = getLayouts;
