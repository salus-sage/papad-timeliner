const path = require('path');
const fs = require('fs');
const cachedPackageJson = require('./cached-package-json');

async function addToPackageJson(packageName, packageVersion, configuration) {
  const config = Object.assign(
    {
      dev: false,
      packagePath: process.cwd(),
    },
    configuration
  );
  const cwd = config.packagePath;
  const prop = config.dev ? 'devDependencies' : 'dependencies';
  const packageJson = cachedPackageJson(cwd);

  if (
    packageJson[prop] &&
    Object.keys(packageJson[prop]).indexOf(packageName) !== -1
  ) {
    return;
  }

  const newPackageJson = Object.assign({}, packageJson);

  newPackageJson[prop] = newPackageJson[prop] ? newPackageJson[prop] : {};
  newPackageJson[prop][packageName] = packageVersion || '*';

  fs.writeFileSync(
    path.join(cwd, 'package.json'),
    JSON.stringify(newPackageJson, null, 2)
  );
}

module.exports = addToPackageJson;
