const path = require('path');
const child_process = require('child_process');
const isLernaPackage = require('./is-lerna-package');
const isLernaRoot = require('./is-lerna-root');

function linkAtPath(atPath, done, err) {
  child_process.exec(
    `${path.join(atPath, 'node_modules', '.bin', 'lerna')} link`,
    { cwd: atPath },
    function(error) {
      if (error) {
        return err(error);
      }
      done();
    }
  );
}

function runLernaLink(packagePath) {
  return new Promise(function(done, err) {
    const cwd = packagePath || process.cwd();

    if (isLernaPackage()) {
      return linkAtPath(path.resolve(path.join(cwd, '..', '..')), done, err);
    }

    if (isLernaRoot()) {
      return linkAtPath(cwd, done, err);
    }

    err('This must be run from a Lerna package or from the Lerna root.');
  });
}

module.exports = runLernaLink;
