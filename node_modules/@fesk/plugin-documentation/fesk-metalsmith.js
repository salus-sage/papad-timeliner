const fs = require('fs');
const path = require('path');
const markdownPlugin = require('@fesk/plugin-markdown');

module.exports = function(metalsmith, configuration) {
  const config = configuration || {};

  if (config.isRoot !== true) {
    configuration.assetFilePath = '../assets';
    configuration.assetFileDestination = 'dist';

    metalsmith
      .clean(true)
      .source('src/docs')
      .destination('dist/docs');
  }

  return markdownPlugin(
    metalsmith.ignore('config.json').use((files, ms) => {
      if (!files['layouts/default.twig']) {
        files['layouts/default.twig'] = {
          mode: '0644',
          contents: fs.readFileSync(
            path.resolve(
              __dirname,
              'lib',
              'layouts',
              'documentationLayout.twig'
            )
          ),
        };
      }
    }),
    config
  );
};
