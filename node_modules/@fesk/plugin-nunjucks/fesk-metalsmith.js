const manifest = require('metalsmith-webpack-manifest');
const permalinks = require('metalsmith-permalinks');
const paths = require('metalsmith-paths/lib/node7');
const nunjucks = require('@fesk/metalsmith-nunjucks');
const viewModel = require('metalsmith-view-model');
const jsonLoader = require('metalsmith-json-loader');

module.exports = function(metalsmith, config) {
  const configuration = {
    viewModels: [],
    jsonLoader: {},
    ...config,
    nunjucks: {
      ...config.nunjucks,
    },
  };

  return metalsmith
    .use(manifest(configuration))
    .use(paths({ property: 'paths' }))
    .use(jsonLoader(configuration.jsonLoader))
    .use(viewModel(configuration.viewModels))
    .use(nunjucks(configuration.nunjucks))
    .use(permalinks({}));
};
