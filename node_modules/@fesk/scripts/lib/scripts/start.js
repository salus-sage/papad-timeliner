const library = require('./parts');
const chalk = require('chalk');

module.exports = async ({ cjs, umd, noServer }) => {
  const packageJson = library.getPackageJson(process.cwd());
  const scripts = library.getPackageJsonScripts(process.cwd());
  const config = library.getConfiguration(process.cwd());

  let total = 2;
  if (umd) {
    total += 1;
  }
  if (cjs) {
    total += 1;
  }

  // Fesk banner.
  library.banner();
  library.tableTop(() =>
    library.log('unicorn_face', 'Building your code before watching')
  );
  library.onExit(() =>
    library.tableFoot(() => library.log('sparkles', 'Stopping watch'))
  );

  // Build templates
  library.log(
    'hammer',
    `Step (1 of ${total}) - ${chalk.blue('Building templates')}`
  );
  await library.buildTemplates(scripts, config);

  // Build assets.
  console.log('\n');
  library.log(
    'package',
    `Step (2 of ${total}) - ${chalk.blue('Building assets')}`
  );
  await library.buildAssets(scripts, config);

  if (umd) {
    console.log('\n');
    library.log(
      'earth_americas',
      `Step (3 of ${total}) - ${chalk.blue('Creating UMD bundle')}`
    );
    await library.buildUmd(packageJson.name, scripts, config);
  }

  if (cjs) {
    console.log('\n');
    library.log(
      'tropical_fish',
      `Step (${umd ? 4 : 3} of ${total}) - ${chalk.blue(
        'Creating CommonJS folder'
      )}`
    );
    await library.buildCjs(scripts, config);
  }

  library.tableMiddle(() => library.log('telescope', 'Watching your assets'));

  const watchConfig = { ...config, watch: true };

  await Promise.all(
    [
      library.buildTemplates(scripts, watchConfig),
      library.buildAssets(scripts, watchConfig),
      cjs ? library.buildCjs(scripts, watchConfig) : null,
      umd ? library.buildUmd(packageJson.name, scripts, watchConfig) : null,
      noServer ? null : library.startLiveServer(config.port),
    ].filter(Boolean)
  );
};
