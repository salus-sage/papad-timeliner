const fs = require('fs');
const util = require('util');
const child_process = require('child_process');
const path = require('path');
const readFile = util.promisify(fs.readFile);
const execFile = util.promisify(child_process.execFile);

async function runFeskScript(script, workingDir) {
  const errorHandler = err => {
    console.log(err.stdout);
    throw Error('Failure.');
  };

  const { stdout } = await execFile(
    path.resolve(path.join(__dirname, 'bin', script + '.js')),
    {
      cwd: workingDir,
      env: {
        ...process.env,
        NODE_ENV: 'production',
      },
    }
  ).catch(errorHandler);

  return stdout.replace(/\s[\d]+m?s/g, ' 1ms');
}

async function assertEachAsset(projectPath, manifest, cb) {
  await Promise.all(
    Object.keys(manifest).map(async file => {
      const filePath = manifest[file];
      const fileContents = await readFile(
        path.join(projectPath, 'dist', 'assets', filePath)
      ).then(f => f.toString());
      cb(file, fileContents, filePath);
    })
  );
}

module.exports = {
  runFeskScript,
  assertEachAsset,
};
