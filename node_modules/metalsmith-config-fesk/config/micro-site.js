const rootOrSubdirectory = require('../lib/rootOrSubdirectory');
const watch = require('../lib/watch');
const microSitePlugin = require('@fesk/plugin-micro-site');

function microSite(metalsmith, configuration) {
  const config = Object.assign(
    {
      isRoot: false,
      microSitePath: 'micro-site',
      assetFilePath: '../assets',
      assetFileDestination: 'dist',
      // Not supported by markdown plugin yet.
      // defaultLayout: 'layouts/default.twig',
    },
    configuration
  );

  return microSitePlugin(
    metalsmith
      .source(`./src/${config.microSitePath}`)
      .destination(config.isRoot ? './dist' : `./dist/${config.microSitePath}`)
      .use(rootOrSubdirectory(config.isRoot, config.microSitePath))
      .use(watch(config)),
    config
  );
}

module.exports = {
  name: 'micro-site',
  metalsmith: microSite,
  path: 'micro-site',
  bundledAssets: require.resolve('../bundles/micro-site'),
};
