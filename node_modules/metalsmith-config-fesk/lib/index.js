const metalsmithPromise = require('./metalsmithPromise');
const fs = require('fs');
const path = require('path');
const all = require('../config/all');

module.exports = async function(configuration = {}) {
  const firstPort = configuration.liveServerPort || 35729;

  const configs = all.filter(config =>
    fs.existsSync(path.join(process.cwd(), 'src', config.path))
  );

  if (configs.length === 1) {
    configuration.isRoot = true;
    configuration.assetFilePath = 'assets';
  }

  if (!configs.length) {
    return;
  }

  return await Promise.all(
    configs.map((config, n) =>
      metalsmithPromise(metalsmith =>
        config.metalsmith(metalsmith, {
          _name: config,
          ...configuration,
          liveServerPort: firstPort + n + 1,
          ...(configuration[config.name] || {}),
        })
      )
    )
  );
};
