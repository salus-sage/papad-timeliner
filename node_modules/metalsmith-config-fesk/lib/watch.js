const metalsmithWatch = require('metalsmith-watch');
const detect = require('detect-port');

function watch(configuration) {
  const config = Object.assign(
    {
      watch: process.env.WATCH || false,
      liveServerPort: true,
      paths: {},
      watchConfig: {},
    },
    configuration
  );

  if (!config.watch) {
    return () => null;
  }

  const liveServerPort = config.liveServerPort || '35730';
  const liveServerPortToUse = detect(liveServerPort);
  const watcher = liveServerPortToUse.then(port =>
    metalsmithWatch({
      paths: {
        ...config.paths,
        '${source}/layouts/*': true,
        '${source}/{**,*}': '{**,*}',
      },
      livereload: port,
      ...config.watchConfig,
    })
  );

  return (a, b) => {
    return watcher.then(cb => cb(a, b, () => {}));
  };
}

module.exports = watch;
